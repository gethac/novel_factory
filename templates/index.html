<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novel Factory - AI小说工厂</title>
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/components.css">
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <h1 style="font-size: 2.5em; letter-spacing: 1px; background: linear-gradient(135deg, #2563eb 0%, #06b6d4 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Novel Factory</h1>
            <p style="font-size: 1.1em; margin-top: 10px;">AI驱动的智能小说创作工厂 · 从灵感到成品，全程自动化</p>
        </div>

        <!-- 导航标签 -->
        <div class="nav-tabs" style="position: relative;">
            <button class="nav-tab active" onclick="app.switchTab('dashboard', event)">仪表盘</button>
            <button class="nav-tab" onclick="app.switchTab('create', event)">创建小说</button>
            <button class="nav-tab" onclick="app.switchTab('novels', event)">小说列表</button>
            <button class="nav-tab" onclick="app.switchTab('tokens', event)">Token统计</button>
            <button class="nav-tab" onclick="app.switchTab('settings', event)">AI配置</button>
            <button class="btn btn-secondary" onclick="app.refreshCurrentTab()"
                    style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); padding: 8px 16px; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                <span style="font-size: 16px;">🔄</span>
                <span>刷新</span>
            </button>
        </div>

        <!-- 仪表盘 -->
        <div id="dashboard" class="tab-content active">
            <h2 style="margin-bottom: 20px; color: var(--text-color);">系统概览</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalNovels">0</h3>
                    <p>总小说数</p>
                </div>
                <div class="stat-card">
                    <h3 id="completedNovels">0</h3>
                    <p>已完成</p>
                </div>
                <div class="stat-card">
                    <h3 id="generatingNovels">0</h3>
                    <p>生成中</p>
                </div>
                <div class="stat-card">
                    <h3 id="failedNovels">0</h3>
                    <p>失败</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalTokens">0</h3>
                    <p>总Token消耗</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalCost">$0.00</h3>
                    <p>总费用</p>
                </div>
            </div>

            <h3 style="margin-bottom: 15px; color: var(--text-color);">最近的小说</h3>
            <div id="recentNovels" class="novel-list"></div>
        </div>

        <!-- 创建小说 -->
        <div id="create" class="tab-content">
            <div style="max-width: 800px; margin: 0 auto;">
                <h2 style="margin-bottom: 20px; color: var(--text-color);">创建新小说任务</h2>
                <form id="createNovelForm">
                    <div class="form-group">
                        <label>小说主题 *</label>
                        <input type="text" id="theme" placeholder="例如：都市修仙、科幻冒险、古代言情等" required>
                    </div>

                    <div class="form-group">
                        <label>背景设定 *</label>
                        <textarea id="background" placeholder="详细描述小说的世界观、时代背景、特殊设定等" required></textarea>
                    </div>

                    <div class="form-group">
                        <label>目标字数 *</label>
                        <input type="number" id="targetWords" value="30000" min="10000" max="1000000" required>
                    </div>

                    <div class="form-group">
                        <label>目标章节数 *</label>
                        <input type="number" id="targetChapters" value="10" min="5" max="200" required>
                    </div>

                    <button type="submit" class="btn btn-primary">创建并开始生成</button>
                </form>
            </div>
        </div>

        <!-- 小说列表 -->
        <div id="novels" class="tab-content">
            <h2 style="margin-bottom: 20px; color: var(--text-color);">所有小说</h2>
            <div id="novelsList" class="novel-list"></div>
        </div>

        <!-- Token统计 -->
        <div id="tokens" class="tab-content">
            <h2 style="margin-bottom: 20px; color: var(--text-color);">💰 Token使用统计</h2>

            <!-- 筛选器 -->
            <div style="background: rgba(245, 247, 250, 0.5); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid var(--border-color);">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label>时间范围</label>
                        <select id="tokenDays" onchange="tokenManager.loadTokenStats()">
                            <option value="7">最近7天</option>
                            <option value="30">最近30天</option>
                            <option value="90">最近90天</option>
                            <option value="0">全部时间</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>筛选小说</label>
                        <select id="tokenNovelFilter" onchange="tokenManager.loadTokenStats()">
                            <option value="">全部小说</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Token统计卡片 -->
            <div class="stats-grid" style="margin-bottom: 30px;">
                <div class="stat-card">
                    <h3 id="tokenStatsTotal">0</h3>
                    <p>总Token</p>
                </div>
                <div class="stat-card">
                    <h3 id="tokenStatsPrompt">0</h3>
                    <p>输入Token</p>
                </div>
                <div class="stat-card">
                    <h3 id="tokenStatsCompletion">0</h3>
                    <p>输出Token</p>
                </div>
                <div class="stat-card">
                    <h3 id="tokenStatsCost">$0.00</h3>
                    <p>总费用</p>
                </div>
            </div>

            <!-- 按阶段统计 -->
            <div class="token-stats-card">
                <h4>📊 按阶段统计</h4>
                <div id="stageStatsTable"></div>
            </div>

            <!-- 按日期趋势 -->
            <div class="token-stats-card">
                <h4>📈 使用趋势</h4>
                <div id="dailyStatsTable"></div>
            </div>

            <!-- 详细记录 -->
            <div class="token-stats-card">
                <h4>📝 详细记录</h4>
                <div id="tokenUsagesList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- AI配置 -->
        <div id="settings" class="tab-content">
            <h2 style="margin-bottom: 20px; color: var(--text-color);">AI模型配置</h2>
            <button class="btn btn-primary" onclick="app.showModal('addConfigModal')" style="margin-bottom: 20px;">
                添加新配置
            </button>
            <div id="configsList" class="novel-list"></div>
        </div>
    </div>

    <!-- 进度监控模态框 -->
    <div id="progressModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="progressModalTitle">生成进度</h2>
                <span class="close-btn" onclick="app.closeModal('progressModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="progressModalContent"></div>
            </div>
        </div>
    </div>

    <!-- 小说详情模态框 -->
    <div id="novelDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalNovelTitle">小说详情</h2>
                <span class="close-btn" onclick="app.closeModal('novelDetailModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="novelDetailContent"></div>
            </div>
        </div>
    </div>

    <!-- 日志模态框 -->
    <div id="logsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>生成日志</h2>
                <span class="close-btn" onclick="app.closeModal('logsModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="logsContent"></div>
            </div>
        </div>
    </div>

    <!-- 添加配置模态框 -->
    <div id="addConfigModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>添加AI配置</h2>
                <span class="close-btn" onclick="app.closeModal('addConfigModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addConfigForm">
                    <div class="form-group">
                        <label>配置名称 *</label>
                        <input type="text" id="configName" placeholder="例如：OpenAI GPT-4" required>
                    </div>
                    <div class="form-group">
                        <label>API地址 *</label>
                        <input type="text" id="configApiBase" placeholder="https://api.openai.com/v1" required>
                    </div>
                    <div class="form-group">
                        <label>API密钥 *</label>
                        <input type="password" id="configApiKey" required>
                    </div>
                    <div class="form-group">
                        <label>模型名称 *</label>
                        <input type="text" id="configModelName" placeholder="gpt-4" required>
                    </div>
                    <div class="form-group">
                        <label>配置类型 *</label>
                        <select id="configType" required>
                            <option value="both">通用（生成+校验）</option>
                            <option value="generation">仅用于生成</option>
                            <option value="check">仅用于校验</option>
                        </select>
                        <small style="color: var(--text-secondary); display: block; margin-top: 5px;">
                            💡 提示：可以为生成和校验配置不同的模型，例如用GPT-4生成，用GPT-3.5校验以节省成本
                        </small>
                    </div>
                    <button type="submit" class="btn btn-primary">保存配置</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 编辑配置模态框 -->
    <div id="editConfigModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>编辑AI配置</h2>
                <span class="close-btn" onclick="app.closeModal('editConfigModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editConfigForm">
                    <input type="hidden" id="editConfigId">
                    <div class="form-group">
                        <label>配置名称 *</label>
                        <input type="text" id="editConfigName" placeholder="例如：OpenAI GPT-4" required>
                    </div>
                    <div class="form-group">
                        <label>API地址 *</label>
                        <input type="text" id="editConfigApiBase" placeholder="https://api.openai.com/v1" required>
                    </div>
                    <div class="form-group">
                        <label>API密钥 *</label>
                        <input type="password" id="editConfigApiKey" placeholder="留空则不修改">
                        <small style="color: var(--text-secondary); display: block; margin-top: 5px;">
                            💡 提示：如不需要修改密钥，请留空
                        </small>
                    </div>
                    <div class="form-group">
                        <label>模型名称 *</label>
                        <input type="text" id="editConfigModelName" placeholder="gpt-4" required>
                    </div>
                    <div class="form-group">
                        <label>配置类型 *</label>
                        <select id="editConfigType" required>
                            <option value="both">通用（生成+校验）</option>
                            <option value="generation">仅用于生成</option>
                            <option value="check">仅用于校验</option>
                        </select>
                        <small style="color: var(--text-secondary); display: block; margin-top: 5px;">
                            💡 提示：可以为生成和校验配置不同的模型
                        </small>
                    </div>
                    <button type="submit" class="btn btn-primary">保存修改</button>
                </form>
            </div>
        </div>
    </div>

    <!-- 引入JavaScript模块 -->
    <script src="/static/js/api.js"></script>
    <script src="/static/js/novel.js"></script>
    <script src="/static/js/modules.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>
